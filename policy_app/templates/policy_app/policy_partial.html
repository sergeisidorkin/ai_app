<div id="policy-pane">
    <div class="d-flex justify-content-between align-items-center mb-3 table-section-header" style="margin-top: 0px;">
        <h5 class="table-section-title">
            <i class="bi bi-table me-2"></i>
            Типовые продукты
        </h5>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
            <tr>
                <th style="width:1%">
                    {% if request.user.is_authenticated and request.user.is_staff %}
                        <div class="form-check m-0">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="defaults-master"
                                   data-target-name="defaults"
                                   data-actions-id="products-actions"
                                   aria-label="Выделить все строки продуктов">
                        </div>
                    {% endif %}
                </th>
                <th>Краткое имя</th>
                <th>Наименование на английском языке</th>
                <th>Наименование на русском языке</th>
                <th>Тип услуги</th>
            </tr>
            </thead>
            <tbody>
            {% for p in products %}
                <tr data-product-id="{{ p.id }}"
                    data-edit-url="{% url 'product_form_edit' p.pk %}"
                    data-delete-url="{% url 'product_delete' p.pk %}"
                    data-move-up-url="{% url 'product_move_up' p.pk %}"
                    data-move-down-url="{% url 'product_move_down' p.pk %}">

                    <td class="text-nowrap">
                        {% if request.user.is_authenticated and request.user.is_staff %}
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="prod-def-{{ p.id }}"
                                       name="defaults"
                                       value="{{ p.id }}"
                                       aria-label="Выделить строку">
                            </div>
                        {% else %}
                        {% endif %}
                    </td>
                    <td class="text-nowrap">{{ p.short_name }}</td>
                    <td>{{ p.name_en }}</td>
                    <td>{{ p.name_ru }}</td>
                    <td class="text-nowrap">{{ p.service_type }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="5" class="text-muted">Пока нет данных.</td></tr>
            {% endfor %}
            </tbody>
        </table>

        {% if request.user.is_authenticated and request.user.is_staff %}
            <!-- Панель под таблицей: кнопка "Добавить строку" + динамические иконки действий -->
            <div class="d-flex align-items-stretch gap-2 products-actions-row">
                <button
                        class="btn btn-primary btn-sm d-flex align-items-center"

                        hx-get="{% url 'product_form_create' %}"
                        hx-target="#policy-modal .modal-content"
                        hx-swap="innerHTML"
                        data-bs-toggle="modal"
                        data-bs-target="#policy-modal">
                    <i class="bi bi-plus-circle me-2"></i>Добавить строку
                </button>
                <div id="products-actions" class="d-none d-flex">
                    <div class="btn-group">
                        <button type="button" id="products-actions-up" data-panel-action="up" class="btn btn-outline-primary btn-sm h-100 py-0" title="Переместить вверх" aria-label="Переместить вверх">
                            <i class="bi bi-arrow-up-square"></i>
                        </button>
                        <button type="button" id="products-actions-down" data-panel-action="down" class="btn btn-outline-primary btn-sm h-100 py-0" title="Переместить вниз" aria-label="Переместить вниз">
                            <i class="bi bi-arrow-down-square"></i>
                        </button>
                        <button type="button" id="products-actions-edit" data-panel-action="edit" class="btn btn-outline-primary btn-sm h-100 py-0" title="Изменить" aria-label="Изменить">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button type="button" id="products-actions-delete" data-panel-action="delete" class="btn btn-outline-danger btn-sm h-100 py-0" title="Удалить" aria-label="Удалить">
                            <i class="bi bi-x-square"></i>
                        </button>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 table-section-header" style="margin-top: 50px;">
        <h5 class="table-section-title">
            <i class="bi bi-table me-2"></i>
            Типовые разделы
        </h5>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
            <tr>
                <th style="width:1%">
                    {% if request.user.is_authenticated and request.user.is_staff %}
                        <div class="form-check m-0">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="sections-master"
                                   data-target-name="section-select"
                                   data-actions-id="sections-actions"
                                   aria-label="Выделить все строки разделов">
                        </div>
                    {% endif %}
                </th>
                <th>Продукт</th>
                <th>Код</th>
                <th>Краткое имя</th>
                <th>Наименование раздела на английском языке</th>
                <th>Наименование раздела на русском языке</th>
                <th>Тип учета</th>
                <th>Исполнитель</th>
            </tr>
            </thead>
            <tbody>
            {% for s in sections %}
                 <tr
                     data-edit-url="{% url 'section_form_edit' s.pk %}"
                     data-delete-url="{% url 'section_delete' s.pk %}"
                     data-move-up-url="{% url 'section_move_up' s.pk %}"
                     data-move-down-url="{% url 'section_move_down' s.pk %}">

                    <td class="text-nowrap">
                        {% if request.user.is_authenticated and request.user.is_staff %}
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="section-sel-{{ s.id }}"
                                       name="section-select"
                                       value="{{ s.id }}"
                                       aria-label="Выделить строку раздела">
                            </div>
                        {% endif %}
                    </td>
                    <td class="text-nowrap">{{ s.product.short_name }}</td>
                    <td class="text-nowrap">{{ s.code }}</td>
                    <td class="text-nowrap">{{ s.short_name }}</td>
                    <td>{{ s.name_en }}</td>
                    <td>{{ s.name_ru }}</td>
                    <td class="text-nowrap">{{ s.accounting_type }}</td>
                    <td class="text-nowrap">{{ s.executor }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="10" class="text-muted">Пока нет данных.</td></tr>
            {% endfor %}
            </tbody>
        </table>

        {% if request.user.is_authenticated and request.user.is_staff %}
        <!-- Панель под таблицей "Типовые разделы": показывается глобальным скриптом -->
        <div class="d-flex align-items-stretch gap-2 products-actions-row">
          <button
                  class="btn btn-primary btn-sm d-flex align-items-center"
                  hx-get="{% url 'section_form_create' %}"
                  hx-target="#policy-modal .modal-content"
                  hx-swap="innerHTML"
                  data-bs-toggle="modal"
                  data-bs-target="#policy-modal">
            <i class="bi bi-plus-circle me-2"></i>Добавить строку
          </button>
          <div id="sections-actions" class="d-none d-flex">
            <div class="btn-group">
              <button type="button" id="sections-actions-up" data-panel-action="up" class="btn btn-outline-primary btn-sm h-100 py-0" title="Переместить вверх" aria-label="Переместить вверх">
                <i class="bi bi-arrow-up-square"></i>
              </button>
              <button type="button" id="sections-actions-down" data-panel-action="down" class="btn btn-outline-primary btn-sm h-100 py-0" title="Переместить вниз" aria-label="Переместить вниз">
                <i class="bi bi-arrow-down-square"></i>
              </button>
              <button type="button" id="sections-actions-edit" data-panel-action="edit" class="btn btn-outline-primary btn-sm h-100 py-0" title="Изменить" aria-label="Изменить">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button type="button" id="sections-actions-delete" data-panel-action="delete" class="btn btn-outline-danger btn-sm h-100 py-0" title="Удалить" aria-label="Удалить">
                <i class="bi bi-x-square"></i>
              </button>
            </div>
          </div>
        </div>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 table-section-header" style="margin-top: 50px;">
        <h5 class="table-section-title">
            <i class="bi bi-table me-2"></i>
            Типовая структура раздела
        </h5>
    </div>

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
            <tr>
                <th style="width:1%">
                    {% if request.user.is_authenticated and request.user.is_staff %}
                        <div class="form-check m-0">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="structures-master"
                                   data-target-name="structure-select"
                                   data-actions-id="structures-actions"
                                   aria-label="Выделить все строки структуры">
                        </div>
                    {% endif %}
                </th>
                <th>Продукт</th>
                <th>Раздел</th>
                <th>Подразделы</th>
            </tr>
            </thead>
            <tbody>
            {% for st in structures %}
                <tr data-edit-url="{% url 'structure_form_edit' st.pk %}"
                    data-delete-url="{% url 'structure_delete' st.pk %}"
                    data-move-up-url="{% url 'structure_move_up' st.pk %}"
                    data-move-down-url="{% url 'structure_move_down' st.pk %}">

                    <td class="text-nowrap">
                        {% if request.user.is_authenticated and request.user.is_staff %}
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       id="struct-sel-{{ st.id }}"
                                       name="structure-select"
                                       value="{{ st.id }}"
                                       aria-label="Выделить строку структуры">
                            </div>
                        {% endif %}
                    </td>
                    <td class="text-nowrap">{{ st.product.short_name }}</td>
                    <td class="text-nowrap">{{ st.section.short_name }}</td>
                    <td>{{ st.subsections }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="4" class="text-muted">Пока нет данных.</td></tr>
            {% endfor %}
            </tbody>
        </table>

        {% if request.user.is_authenticated and request.user.is_staff %}
        <div class="d-flex align-items-stretch gap-2 products-actions-row">
          <button
                  class="btn btn-primary btn-sm d-flex align-items-center"
                  hx-get="{% url 'structure_form_create' %}"
                  hx-target="#policy-modal .modal-content"
                  hx-swap="innerHTML"
                  data-bs-toggle="modal"
                  data-bs-target="#policy-modal">
            <i class="bi bi-plus-circle me-2"></i>Добавить строку
          </button>
          <div id="structures-actions" class="d-none d-flex">
            <div class="btn-group">
              <button type="button" id="structures-actions-up" data-panel-action="up" class="btn btn-outline-primary btn-sm h-100 py-0" title="Переместить вверх" aria-label="Переместить вверх">
                <i class="bi bi-arrow-up-square"></i>
              </button>
              <button type="button" id="structures-actions-down" data-panel-action="down" class="btn btn-outline-primary btn-sm h-100 py-0" title="Переместить вниз" aria-label="Переместить вниз">
                <i class="bi bi-arrow-down-square"></i>
              </button>
              <button type="button" id="structures-actions-edit" data-panel-action="edit" class="btn btn-outline-primary btn-sm h-100 py-0" title="Изменить" aria-label="Изменить">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button type="button" id="structures-actions-delete" data-panel-action="delete" class="btn btn-outline-danger btn-sm h-100 py-0" title="Удалить" aria-label="Удалить">
                <i class="bi bi-x-square"></i>
              </button>
            </div>
          </div>
        </div>
        {% endif %}
    </div>
</div>