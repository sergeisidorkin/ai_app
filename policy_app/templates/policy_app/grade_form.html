<div class="modal-header">
  <h5 class="modal-title">
    {% if action == "create" %}Добавить грейд{% else %}Изменить грейд{% endif %}
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form
    method="post"
    {% if action == "create" %}
      hx-post="{% url 'grade_form_create' %}"
    {% else %}
      hx-post="{% url 'grade_form_edit' grade.pk %}"
    {% endif %}
    hx-target="#policy-pane"
    hx-swap="outerHTML">
  <div class="modal-body">
    {% csrf_token %}

    {% if is_admin %}
    <div class="mb-3">
      <label class="form-label">Руководитель направления</label>
      {{ form.owner }}
    </div>
    {% endif %}

    <div class="mb-3">
      <label class="form-label">Грейд на английском языке</label>
      {{ form.grade_en }}
    </div>
    <div class="mb-3">
      <label class="form-label">Грейд на русском языке</label>
      {{ form.grade_ru }}
    </div>
    <div class="mb-3">
      <label class="form-label">Число уровней квалификации</label>
      {{ form.qualification_levels }}
    </div>

    <div class="mb-3">
      <label class="form-label">Квалификация</label>
      {{ form.qualification }}
      <div id="star-rating-widget" class="d-flex gap-1" style="font-size: 1.5rem; cursor: pointer;">
      </div>
    </div>

    <div class="mb-3 form-check">
      {{ form.is_base_rate }}
      <label class="form-check-label" for="id_is_base_rate">Базовая ставка</label>
    </div>
    <div class="mb-3" id="share-field-wrap">
      <label class="form-label">Доля базовой ставки, %</label>
      <div class="input-group" style="max-width:160px;">
        {{ form.base_rate_share }}
        <span class="input-group-text">%</span>
      </div>
    </div>

    {% if form.errors %}
      <div class="alert alert-danger mb-0">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <div>{{ error }}</div>
          {% endfor %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
    <button type="submit" class="btn btn-primary">Сохранить</button>
  </div>
</form>

<script>
(function() {
  var STAR_ACTIVE = 'bi bi-star-fill text-warning';
  var STAR_EMPTY = 'bi bi-star-fill';
  var STAR_EMPTY_STYLE = 'color:#dee2e6;';

  var levelsInput = document.getElementById('id_qualification_levels');
  var hiddenInput = document.getElementById('id_qualification');
  var container = document.getElementById('star-rating-widget');

  function starClass(filled) { return filled ? STAR_ACTIVE : STAR_EMPTY; }

  if (levelsInput && hiddenInput && container) {
    function render(max, current) {
      container.innerHTML = '';
      for (var i = 1; i <= max; i++) {
        var star = document.createElement('i');
        var filled = i <= current;
        star.className = starClass(filled);
        if (!filled) star.style.cssText = STAR_EMPTY_STYLE;
        star.dataset.value = i;
        star.addEventListener('click', function() {
          var val = parseInt(this.dataset.value);
          if (parseInt(hiddenInput.value) === val) { hiddenInput.value = 0; val = 0; }
          else { hiddenInput.value = val; }
          render(parseInt(levelsInput.value) || 5, val);
        });
        star.addEventListener('mouseenter', function() {
          var hv = parseInt(this.dataset.value);
          container.querySelectorAll('i').forEach(function(s) {
            var sv = parseInt(s.dataset.value);
            var f = sv <= hv;
            s.className = starClass(f);
            s.style.cssText = f ? '' : STAR_EMPTY_STYLE;
          });
        });
        container.appendChild(star);
      }
      container.addEventListener('mouseleave', function() {
        var cv = parseInt(hiddenInput.value) || 0;
        container.querySelectorAll('i').forEach(function(s) {
          var sv = parseInt(s.dataset.value);
          var f = sv <= cv;
          s.className = starClass(f);
          s.style.cssText = f ? '' : STAR_EMPTY_STYLE;
        });
      }, { once: false });
    }

    render(parseInt(levelsInput.value) || 5, parseInt(hiddenInput.value) || 0);

    levelsInput.addEventListener('change', function() {
      var newMax = parseInt(this.value) || 5;
      var cur = parseInt(hiddenInput.value) || 0;
      if (cur > newMax) { hiddenInput.value = newMax; cur = newMax; }
      render(newMax, cur);
    });
  }

  var baseRateCb = document.getElementById('id_is_base_rate');
  var shareInput = document.getElementById('id_base_rate_share');
  if (baseRateCb && shareInput) {
    function toggleShare() {
      if (baseRateCb.checked) {
        shareInput.value = '';
        shareInput.readOnly = true;
        shareInput.tabIndex = -1;
        shareInput.style.backgroundColor = '#e9ecef';
        shareInput.style.color = '#6c757d';
      } else {
        shareInput.readOnly = false;
        shareInput.tabIndex = 0;
        shareInput.style.backgroundColor = '';
        shareInput.style.color = '';
      }
    }
    toggleShare();
    baseRateCb.addEventListener('change', toggleShare);
  }
})();
</script>
