{% if error and not rows %}
  <div class="alert alert-warning mb-0">{{ error }}</div>
{% elif not project %}
  <div class="alert alert-info mb-0">Выберите проект, чтобы увидеть записи.</div>
{% elif not section %}
  <div class="alert alert-warning mb-0">{{ error|default:"Не удалось определить раздел" }}</div>
{% elif not legal_entities %}
  <div class="alert alert-warning mb-0">В выбранном активе нет юридических лиц.</div>
{% elif not rows %}
  <div class="alert alert-info mb-0">Для выбранного продукта и раздела нет запросов.</div>
{% else %}
  <table class="table table-sm align-middle table-bordered">
    <colgroup>
        <col> <!-- Код -->
        <col> <!-- № -->
        <col> <!-- Краткое название -->
        <col> <!-- Наименование -->
        {% for entity in legal_entities %}
          <col class="status-col"> <!-- статус -->
          <col class="date-col">
        {% endfor %}
        <col class="comment-col"> <!-- IMC -->
        <col class="comment-col"> <!-- Заказчик -->
    </colgroup>
    <thead class="table-light">
      <tr>
        <th class="col-code">Код</th>
        <th class="col-num">№</th>
        <th>Краткое наименование</th>
        <th>Наименование запроса</th>
        {% for entity in legal_entities %}
          <th class="status-col text-nowrap">
            {{ entity.legal_name|default:entity.work_name|default:entity.work_item.asset_name|default:"Юридическое лицо" }}
          </th>
          <th class="text-nowrap date-header">Дата</th>
        {% endfor %}
        <th class="col-comment col-comment-imc">Комментарий IMC Montan</th>
        <th class="col-comment col-comment-customer">Комментарий Заказчика</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr>
          <td id="chk-code-{{ row.item.id }}" class="col-code text-nowrap {{ row.code_class }}">{{ row.item.code }}</td>
          <td id="chk-num-{{ row.item.id }}" class="col-num text-nowrap">{{ row.item.number|stringformat:"02d" }}</td>
          <td class="text-nowrap">{{ row.item.short_name }}</td>
          <td>{{ row.item.name }}</td>

          {% for cell in row.statuses %}
            <td class="status-cell status-col" id="status-cell-{{ row.item.id }}-{{ cell.entity.id }}">
              <div class="checklist-status-cell" id="chk-cell-{{ row.item.id }}-{{ cell.entity.id }}">
                <form
                  hx-post="{{ update_status_url }}"
                  hx-trigger="change from:select"
                  hx-target="#chk-cell-{{ row.item.id }}-{{ cell.entity.id }}"
                  hx-swap="outerHTML">
                  {% csrf_token %}
                  <input type="hidden" name="request_item" value="{{ row.item.id }}">
                  <input type="hidden" name="legal_entity" value="{{ cell.entity.id }}">
                  <input type="hidden" name="asset_name" value="{{ asset_name }}">
                  <select name="status" class="form-select form-select-sm">
                    {% for value,label in status_choices %}
                      {% if cell.status %}
                        <option value="{{ value }}" {% if value == cell.status.status %}selected{% endif %}>{{ label }}</option>
                      {% else %}
                        <option value="{{ value }}" {% if value == default_status %}selected{% endif %}>{{ label }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </form>
              </div>
            </td>
            <td class="date-cell text-nowrap" id="date-cell-{{ row.item.id }}-{{ cell.entity.id }}">
              {% if cell.status and cell.status.status_changed_at %}
                {{ cell.status.status_changed_at|date:"d.m.y H:i" }}
              {% else %}
                —
              {% endif %}
            </td>
          {% endfor %}

          <td class="col-comment col-comment-imc">
            {% include "checklists_app/components/comment_cell.html" with field="imc_comment" request_item=row.item project=project section=section asset_name=asset_name note=row.note histories=row.history.imc_comment add_comment_url=add_comment_url %}
          </td>
          <td class="col-comment col-comment-customer">
            {% include "checklists_app/components/comment_cell.html" with field="customer_comment" request_item=row.item project=project section=section asset_name=asset_name note=row.note histories=row.history.customer_comment add_comment_url=add_comment_url %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {# Модалки комментариев — вне таблицы #}
  <div id="checklists-comment-modals">
    {% for row in rows %}
      {% include "checklists_app/components/comment_modal.html" with field="imc_comment" request_item=row.item project=project section=section asset_name=asset_name note=row.note histories=row.history.imc_comment add_comment_url=add_comment_url %}
      {% include "checklists_app/components/comment_modal.html" with field="customer_comment" request_item=row.item project=project section=section asset_name=asset_name note=row.note histories=row.history.customer_comment add_comment_url=add_comment_url %}
    {% endfor %}
  </div>
  <style>
    #checklists-table-wrap table th,
    #checklists-table-wrap table td {
        padding-left: 7px !important;
        padding-right: 7px !important;
        vertical-align: top;
        text-align: left;
        font-size: 0.9rem;
        color: #212529;
        font-weight: 400;
    }

    #checklists-table-wrap table td {
        padding-top: 11px !important;
        padding-bottom: 11px !important;
    }
    #checklists-table-wrap table td.date-cell {
        padding-top: 11.5px !important;
        padding-bottom: 11.5px !important;
    }
    #checklists-table-wrap table td.status-cell {
        padding: 7px !important;
    }

    #checklists-table-wrap table th {
        white-space: nowrap;
    }

    #checklists-table-wrap table tbody tr {
        background-color: transparent;
    }

    /* общее подсвечивание строки */
    #checklists-table-wrap table tbody tr td:not(.col-code) {
        transition: background-color .15s ease;
    }
    #checklists-table-wrap table tbody tr:hover td:not(.col-code) {
        background-color: #1c1d200b;
    }
    /* код и номер темнеют ровно настолько, чтобы не терять исходный цвет */
    #checklists-table-wrap table tbody tr td.col-code {
        transition: filter .15s ease;
    }
    #checklists-table-wrap table tbody tr:hover td.col-code {
        filter: brightness(0.95); /* чем меньше значение, тем темнее */
    }

    #checklists-table-wrap table .form-select {
        background-color: transparent !important;
        background-image: var(--bs-form-select-bg-img);  /* вернёт стрелку Bootstrap */
        box-shadow: none;
    }

    #checklists-table-wrap table .form-select:focus {
        color: inherit;
        background-color: transparent !important;
        border-color: #ced4da;         /* обычная серая граница */
        box-shadow: none !important;   /* убирает синюю засветку */
    }

    #checklists-table-wrap table thead {
        background-color: #ffffff; /* #e6f0ff светлый синий в тон приложению */
    }

    #checklists-table-wrap table thead th {
        padding-top: 11px;
        padding-bottom: 11px;
        font-weight: 600;
        background-color: transparent; /* чтобы наследовали цвет thead */
    }

    #checklists-table-wrap table .col-code {
        width: 45px;
        min-width: 45px;
        max-width: 45px;
    }

    #checklists-table-wrap table .col-num {
        width: 30px;
        min-width: 30px;
        max-width: 30px;
    }

    #checklists-table-wrap table col.comment-col {
        width: 60px;
        min-width: 60px;
    }

    #checklists-table-wrap table col.status-col {
        min-width: 230px;
        max-width: 420px;
    }
    #checklists-table-wrap table td.status-cell .form-select {
        width: 100%;
        min-width: 0;
        max-width: 100%;
        padding-right: 2rem;  /* чтобы стрелка не залезала на текст */
        box-sizing: border-box;
    }
    #checklists-table-wrap table th.status-col {
        width: 230px;
        min-width: 230px;
        max-width: 420px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #checklists-table-wrap table col.date-col {
        width: 115px;
        min-width: 115px;
    }


    #checklists-table-wrap .comment-placeholder {
        opacity: 0;
        display: inline-block;
        width: 100%;
    }


    #checklists-table-wrap table .chk-code--provided {
    background-color: #d6f5d6;
    }
    #checklists-table-wrap table .chk-code--partial {
    background-color: #ffe6cc;
    }
    #checklists-table-wrap table .chk-code--na {
    background-color: #f0f0f0;
    color: #6c757d;
    }

  </style>
  <script>
    (() => {
      const wrap = document.getElementById('checklists-table-wrap');
      if (!wrap || !window.bootstrap) return;
      wrap.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        bootstrap.Tooltip.getInstance(el)?.dispose();
        new bootstrap.Tooltip(el);
      });
    })();
  </script>
{% endif %}