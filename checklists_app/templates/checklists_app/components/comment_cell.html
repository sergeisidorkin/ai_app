<div  class="checklist-comment"
      id="chk-comment-{{ field }}-{{ request_item.id }}"
      hx-swap-oob="true"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      data-bs-trigger="hover focus"
      title="{% if latest %}{{ latest.text|striptags|escape }}{% elif note %}{% if field == 'imc_comment' %}{{ note.imc_comment|default_if_none:''|striptags|escape }}{% else %}{{ note.customer_comment|default_if_none:''|striptags|escape }}{% endif %}{% else %}Комментарий отсутствует{% endif %}">
    {% with latest=histories|first %}
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="text-truncate">
          {% if latest %}
            {{ latest.text|truncatechars:22 }}
          {% elif note %}
            {% if field == "imc_comment" %}
              {{ note.imc_comment|default:"" }}
            {% else %}
              {{ note.customer_comment|default:"" }}
            {% endif %}
          {% else %}
            <span class="comment-placeholder">&nbsp;</span>
          {% endif %}
        </div>
        <button
          type="button"
          class="btn btn-link btn-sm p-0"
          title="Редактировать комментарий"
          data-bs-toggle="modal"
          data-bs-target="#commentModal-{{ field }}-{{ request_item.id }}">
          <i class="bi bi-pencil-square text-muted"></i>
        </button>
      </div>
    {% endwith %}
  
    <div class="modal fade" id="commentModal-{{ field }}-{{ request_item.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              {% if field == "imc_comment" %}
                Комментарий IMC Montan
              {% else %}
                Комментарий Заказчика
              {% endif %}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <form
              hx-post="{{ add_comment_url }}"
              hx-target="#chk-comment-{{ field }}-{{ request_item.id }}"
              hx-swap="outerHTML"
              hx-on::afterSwap="const modalEl = document.getElementById('commentModal-{{ field }}-{{ request_item.id }}'); if (modalEl) { const modal = bootstrap.Modal.getInstance(modalEl); modal && modal.hide(); } }">
              {% csrf_token %}
              <input type="hidden" name="field" value="{{ field }}">
              <input type="hidden" name="request_item" value="{{ request_item.id }}">
              <input type="hidden" name="project" value="{{ project.id }}">
              <input type="hidden" name="section" value="{{ section.id }}">
              <input type="hidden" name="asset" value="{{ asset_name }}">
  
              <textarea
                class="form-control"
                name="value"
                rows="3"
                placeholder="Введите текст комментария"></textarea>
              <div class="text-end mt-2">
                <button type="submit" class="btn btn-primary btn-sm">Добавить комментарий</button>
              </div>
            </form>
  
            <hr>
  
            <div class="comment-history-list">
              {% if histories %}
                {% for entry in histories %}
                  <div class="mb-3">
                    <div class="small text-muted">
                      {% if entry.author %}
                        {{ entry.author.get_full_name|default:entry.author.username }}
                      {% else %}
                        —
                      {% endif %}
                      · {{ entry.created_at|date:"d.m.Y H:i" }}
                    </div>
                    <div>{{ entry.text|linebreaksbr }}</div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted small">История пока пуста.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>