<div class="modal-header">
  <h5 class="modal-title">
    {% if action == "create" %}Добавить строку{% else %}Изменить строку{% endif %}
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form
    method="post"
    {% if action == "create" %}
      hx-post="{% url 'katd_form_create' %}"
    {% else %}
      hx-post="{% url 'katd_form_edit' division.pk %}"
    {% endif %}
    hx-target="#classifiers-pane"
    hx-swap="outerHTML">
  <div class="modal-body">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">Наименование страны (краткое)</label>
      {{ form.country }}
    </div>
    <div class="mb-3">
      <label class="form-label">Код</label>
      <input type="text" class="form-control" id="katd-country-code" readonly tabindex="-1"
             style="background-color:#f8f9fa; color:#6c757d;"
             value="{% if division %}{{ division.country.code }}{% endif %}">
    </div>
    <div class="mb-3">
      <label class="form-label">Регион</label>
      {{ form.region_name }}
    </div>
    <div class="mb-3">
      <label class="form-label">Код региона</label>
      {{ form.region_code }}
    </div>
    <div class="mb-3">
      <label class="form-label">Дата образования</label>
      {{ form.effective_date }}
    </div>
    <div class="mb-3">
      <label class="form-label">Дата упразднения</label>
      {{ form.abolished_date }}
    </div>
    <div class="mb-3">
      <label class="form-label">Источник</label>
      {{ form.source }}
    </div>

    {% if form.errors %}
      <div class="alert alert-danger mb-0">
        Проверьте введённые данные.
      </div>
    {% endif %}
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
    <button type="submit" class="btn btn-primary">Сохранить</button>
  </div>
</form>

<script>
(function() {
  var countryEl = document.getElementById('id_country');
  var codeEl = document.getElementById('katd-country-code');
  if (!countryEl || !codeEl) return;
  countryEl.addEventListener('change', function() {
    if (!this.value) { codeEl.value = ''; return; }
    fetch('{% url "country_code_lookup" %}?country_id=' + encodeURIComponent(this.value))
      .then(function(r) { return r.json(); })
      .then(function(data) { codeEl.value = data.code || ''; });
  });
})();
</script>
