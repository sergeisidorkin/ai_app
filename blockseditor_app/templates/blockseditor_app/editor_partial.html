{# blockseditor_app/templates/blockseditor_app/editor_partial.html #}
<div class="editor-header d-flex align-items-center justify-content-between gap-3 mb-3">
    <div class="editor-header__nav">
        <button type="button" class="btn btn-link px-0 editor-backlink"
                hx-get="{{ dashboard_url }}"
                hx-target="#templates-pane"
                hx-swap="innerHTML"
                hx-indicator="#templates-loading"
                data-editor-fallback="{{ dashboard_url }}">
            ← Вернуться к блокам
        </button>
    </div>

    <div class="editor-header__meta text-center flex-grow-1">
        <strong>{{ block.code }} {{ block.name }}</strong>
    </div>

    <form id="editor-model-form"
          class="editor-header__actions d-flex align-items-center gap-2 mb-3"
          method="post"
          action="{% url 'blocks_app:blocks_set_model' block.id %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="">

        <button type="button" class="btn btn-outline-secondary btn-sm"
                hx-get="{{ dashboard_url }}"
                hx-target="#templates-pane"
                hx-swap="innerHTML"
                hx-indicator="#templates-loading"
                data-editor-fallback="{{ dashboard_url }}">
            Отмена
        </button>
        <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
    </form>
</div>

<div class="editor-shell d-flex w-100" data-role="editor-root">

    <nav class="editor-sidebar__nav">
        <button class="sidebar-toggle" data-toggle="agents">
            <span class="sidebar-toggle__inner">
                <span>Агенты</span>
                <i class="bi bi-chevron-right" data-toggle-icon></i>
            </span>
        </button>
        <div class="sidebar-submenu" data-menu="agents">
            <button class="sidebar-submenu__item">
                <span>Базовый агент</span>
                <span class="sidebar-submenu__icons">
                    <i class="bi bi-three-dots-vertical"></i>
                    <i class="bi bi-three-dots-vertical"></i>
                </span>
            </button>
            <button class="sidebar-submenu__item">
                <span>Поисковый агент</span>
                <span class="sidebar-submenu__icons">
                    <i class="bi bi-three-dots-vertical"></i>
                    <i class="bi bi-three-dots-vertical"></i>
                </span>
            </button>
        </div>

        <button class="btn btn-outline-secondary w-100" disabled>Настройки</button>
        <button class="btn btn-outline-secondary w-100" disabled>Системные промпты</button>
    </nav>

    <section class="editor-canvas flex-grow-1" data-role="canvas">
        <svg class="editor-connectors" data-role="connectors"></svg>

        {% for node in editor_nodes %}
            <div class="agent-node shadow-sm{% if node.node_type == node.NodeType.AGENT %} agent-node--secondary{% endif %}"
                data-node-id="{{ node.slug }}"
                data-node-type="{{ node.node_type }}"
                data-position-url="{% url 'blockseditor_app:node_position' block.id node.slug %}"
                style="left: {{ node.position_x }}px; top: {{ node.position_y }}px;">
                {% if node.node_type == node.NodeType.CHECKLIST %}
                    <div class="agent-node__title" data-node-handle>{{ node.title }}</div>
                    <div class="agent-node__body">
                        <div class="agent-node__footer" data-role="checklist-output">
                            <span>Все передано</span>
                            <span class="agent-pin agent-pin--right" data-connector="checklist"></span>
                        </div>
                    </div>
                {% elif node.node_type == node.NodeType.AGENT %}
                    <div class="agent-node__title" data-node-handle>{{ node.title }}</div>

                    <div class="agent-node__body">
                        <label class="form-label small text-muted mb-1">Поставщик модели</label>
                        <select class="form-select form-select-sm mb-3">
                            <option value="openai">OpenAI</option>
                            <option value="alibaba">Alibaba Cloud</option>
                        </select>

                        <label class="form-label small text-muted mb-1">Модель</label>
                        <select class="form-select form-select-sm mb-3"
                                name="model"
                                form="editor-model-form"
                                required>
                            <option value="" disabled {% if not block.model %}selected{% endif %}>— Выберите модель —</option>
                            {% for model in llm_models %}
                                <option value="{{ model }}" {% if block.model == model %}selected{% endif %}>
                                    {{ model }}
                                </option>
                            {% endfor %}
                        </select>

                        <label class="form-label small text-muted mb-1">Температура модели</label>
                        <div class="temperature-control d-flex align-items-center gap-3 mb-3">
                            <input type="range"
                                   class="form-range flex-grow-1"
                                   min="0"
                                   max="2"
                                   step="0.1"
                                   name="temperature"
                                   form="editor-model-form"
                                   value="{{ block.temperature|default_if_none:'1' }}"
                                   data-role="agent-temp">
                            <span class="badge bg-light text-dark"
                                  data-role="agent-temp-value">
                                {{ block.temperature|default_if_none:"1.0" }}
                            </span>
                        </div>

                        <label class="form-label small text-muted mb-1">Системный промпт</label>
                        <textarea class="form-control form-control-sm editor-textarea" rows="1"></textarea>

                        <label class="form-label small text-muted mb-1">Специальный промпт</label>
                        <textarea class="form-control form-control-sm editor-textarea" rows="1"></textarea>

                        <div class="agent-node__meta">
                            <label class="form-label small text-muted mb-1 agent-node__meta-line" data-role="agent-meta">
                                <span class="agent-pin" data-connector="agent"></span>
                                Запуск
                            </label>
                            <label class="form-label small text-muted mb-1 agent-node__meta-line">Инструменты</label>
                            <label class="form-label small text-muted mb-1 agent-node__meta-line">Вход</label>
                        </div>
                        <div class="agent-node__footer">
                            <span>Ответ</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </section>
</div>

<style>
    .editor-shell {
        width: 100%;
        margin-left: 0;
    }
    .editor-canvas {
        position: relative;
        overflow: hidden;
        padding: 0;
        margin: 0;
        width: 100%;
        height: calc(100vh - 112px);
        background-color: rgb(216, 216, 223);
        background-image:
            radial-gradient(rgba(0, 0, 0, 0.25) 1.4px, transparent 1.4px),
            radial-gradient(rgba(0, 0, 0, 0.08) 1.4px, transparent 1.4px);
        background-size: 20px 20px;
        background-position: 0 0, 20px 20px;
    }  

    .editor-sidebar { width: 280px; padding: 24px 20px; }
    .editor-sidebar__header { margin-bottom: 24px; }

    .editor-sidebar__nav {
    width: 290px;
    padding: 0;
    margin: 0;
    background: #fff;
    border-right: 1px solid rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    }

    .sidebar-toggle,
    .editor-sidebar__nav .btn {
    border: none;
    border-radius: 0;
    background: #fff;
    color: #111;
    text-align: left;
    padding: 10px 20px 10px 26px;  /* → высота чуть меньше, +2px слева */
    line-height: 1.2;
    width: 100%;
    transition: background .15s ease;
    }

    .editor-sidebar__nav > .btn {
    margin-left: -4px;   /* на 2px меньше, чем у подпунктов */
    margin-right: 2px;
    }

    .sidebar-toggle {
    border: none;
    background: transparent;
    padding: 6px 0;
    }

    .sidebar-toggle__inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: -1px 10px -6px 11px;  /* ← было 0 9px 0 10px */
    padding: 8px 12px;
    border-radius: 8px;
    background: #fff;
    transition: background .15s ease;
    }

    .sidebar-toggle__inner:hover {
    background: #f2f2f5;
    }

    .sidebar-submenu {
    border-bottom: none;
    overflow: hidden;
    max-height: 0;
    transition: max-height .2s ease;
    }

    .sidebar-submenu.show {
    max-height: 250px;
    }

    .sidebar-toggle i {
        transition: transform .2s ease;
    }
    .sidebar-toggle i.rotate {
        transform: rotate(90deg); /* из > в v */
    }

    .sidebar-submenu__item {
    border: none;
    border-radius: 8px;              /* было 10px */
    background: #f2f2f5;
    color: #111;
    width: calc(100% - 20px);
    margin: 4px 5px 4px 10px; /* слева 10px, справа 5px */
    padding: 8px 8px 8px 10px;               /* одинаковые отступы слева/справа */
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background .15s ease;
    line-height: 1.2;
    }

    .sidebar-submenu__item:hover {
    background: #e4e4ea;
    }

    .sidebar-submenu__item span:first-child {
        padding-left: 2px;             /* чтобы визуально добавить те же +2px */
    }

    .sidebar-btn {
    border: none;
    background: transparent;
    padding: 6px 0;
    width: 100%;
    }
    .sidebar-btn:disabled .sidebar-toggle__inner {
    background: #fff;
    opacity: 0.6;
    }
    .sidebar-btn:disabled:hover .sidebar-toggle__inner {
    background: #fff;  /* отключаем ховер */
    }

    .sidebar-submenu__icons {
    display: flex;
    gap: 0;
    color: #6c757d;
    font-size: 1rem;
    }

    .sidebar-submenu__icons i + i {
    margin-left: -10px;   /* подбери значение (-3…-5) */
    }
    
    .editor-header__actions {
    justify-content: flex-end;
    }

    .agent-node {
        position: absolute;
        overflow: visible;
        width: 400px;
        border-radius: 18px;
        background: #fff;
        border: 3px solid #d7d7dc;
        color: #212529;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        transition: transform .1s ease;
        cursor: grab;
    }
    .agent-node__title {
        padding: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .agent-node__body {
        padding: 18px 22px 22px;
        color: #6c757d;
    }


    .agent-node__title[data-node-handle] {
        cursor: grab;
        user-select: none;
    }

    .agent-node.is-dragging,
    .agent-node.is-dragging [data-node-handle] {
        cursor: grabbing;
    }

    .agent-node__meta {
    position: relative;
    overflow: visible;
    padding-left: 0px;
    margin: 1rem 0;
    }
    .agent-node__meta-line {
    display: block;
    position: relative;
    padding-left: 0px;
    color: #8a8f99;
    margin-bottom: .35rem;
    }

    .agent-node__meta-line::before {
    content: '';
    position: absolute;
    left: -30.5px;
    top: 50%;
    width: 17px;
    height: 17px;
    border-radius: 50%;
    background: #075D94;
    border: 3.5px solid #b4d5f2;
    transform: translateY(-50%);
    box-shadow: none;
    transition: box-shadow .2s ease;
    }

    .agent-node__meta-line:hover::before {
    box-shadow: 0 0 12px rgba(7, 93, 148, 0.65);
    }

    .agent-node__footer {
    position: relative;
    background: #f2f3f5;
    margin: 0 -22px -22px;
    padding: 10px 22px;
    display: flex;
    justify-content: flex-end;
    font-size: 0.95rem;
    font-weight: 500;
    color: #4a4f58;
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 18px;
    overflow: visible;
    }

    .agent-node__footer::after {
    content: '';
    position: absolute;
    right: -1px;          /* подгони, чтобы центр совпал с границей */
    top: 50%;
    width: 17px;
    height: 17px;
    border-radius: 50%;
    background: #8f59fb;
    border: 3.5px solid #dfceff;
    transform: translate(50%, -50%);
    transition: box-shadow .2s ease;
    }

    .agent-node__footer:hover::after {
    box-shadow: 0 0 12px rgba(149, 26, 249, 0.65);
    }



    .editor-backlink {
    text-decoration: none;
    }
    .editor-backlink:hover {
    text-decoration: none;
    }

    .editor-header {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    }

    .editor-header__cell {
    display: flex;
    justify-content: flex-start;
    }

    .editor-header__cell:last-child {
    justify-content: flex-end;
    }

    .editor-header__meta {
    font-size: 1rem;
    gap: 4px;
    flex-direction: column;
    color: #343a40;
    }

    .agent-node__body textarea { resize: none; }
    .temperature-control .form-range { accent-color: #868789; }


    .agent-node__body .temperature-control {
    margin-top: 0.35rem;   /* чуть больше расстояние от label */
    }
    .agent-node__body .form-range {
    height: 4px;
    padding: 0;
    }

    .agent-node__body .form-range::-webkit-slider-runnable-track {
    background: #d5d7dc;
    height: 4px;
    border-radius: 999px;
    }

    .agent-node__body .form-range::-webkit-slider-thumb {
    width: 14px;
    height: 14px;
    margin-top: -5px;
    background: #b0b3bb;
    border: 2px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    }

    .agent-node__body .form-range::-moz-range-track { /* Firefox */
    background: #d5d7dc;
    height: 4px;
    border-radius: 999px;
    }

    .agent-node__body .form-range::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: #b0b3bb;
    border: 2px solid #fff;
    border-radius: 50%;
    cursor: pointer;
    }


    .editor-connectors {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    }

    .connector-line {
    stroke: #000000;
    stroke-width: 2;
    fill: none;
    }
    .connector-line__end {
    fill: #075D94;
    }



    .agent-pin {
     position: absolute;
     width: 17px;
     height: 17px;
     border-radius: 50%;
     background: #075D94;
     border: 3.5px solid #b4d5f2;
     box-shadow: none;
     transition: box-shadow .2s ease;
    }
    .agent-node__meta-line .agent-pin {
     left: -21.5px;
     top: 50%;
     transform: translate(-50%, -50%);
    }
    .agent-node__footer .agent-pin--right {
     right: -1px;
     top: 50%;
     transform: translate(50%, -50%);
    }

    .editor-header__actions button {
    transform: translateY(8px);   /* локальный сдвиг вниз */
    }

    .editor-header__actions .btn-primary {
      margin-right: 15px;           /* внешний отступ справа от «Сохранить» */
    }

</style>

<script>
    (function () {
      const stage = document.querySelector('.editor-canvas');
      if (!stage) return;

      const nodes = stage.querySelectorAll('[data-node-id]');
      const nodeMap = new Map(
        [...nodes].map(node => [node.dataset.nodeId, node])
      );

      const connectorsLayer = document.querySelector('[data-role="connectors"]');
      const pane = document.getElementById('templates-pane');
      const form = document.getElementById('editor-model-form');

      pane?.classList.add('templates-pane--editor');
      pane?.closest('main')?.classList.add('templates-main--editor');
      pane?.closest('.flex-grow-1')?.classList.add('templates-content--editor');
      pane?.parentElement?.classList.add('templates-pane-wrap--editor');

      const connectors = [
        { from: '.agent-pin[data-connector="agent"]', to: '.agent-pin[data-connector="checklist"]' }
      ];

      const INTERACTIVE_SELECTOR = 'select, textarea, input, button';
      const HANDLE_SELECTOR = '[data-node-handle]';

      let dragging = false;
      let pointerId = null;
      let draggedNode = null;
      let offsetX = 0;
      let offsetY = 0;
      let hasMoved = false;

      const pendingPositions = new Map(); // slug -> { x, y }

      function getCsrfToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : '';
      }

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function canStartDrag(event) {
        const node = event.currentTarget;
        const handleOnly = node.hasAttribute('data-handle-only');
        if (handleOnly) {
          return Boolean(event.target.closest(HANDLE_SELECTOR));
        }
        return !event.target.closest(INTERACTIVE_SELECTOR);
      }

      function updateConnectors() {
        if (!connectorsLayer) return;
        connectorsLayer.innerHTML = '';
        connectors.forEach(({ from, to }) => {
          const a = document.querySelector(from);
          const b = document.querySelector(to);
          if (!a || !b) return;

          const rectA = a.getBoundingClientRect();
          const rectB = b.getBoundingClientRect();
          const offset = connectorsLayer.getBoundingClientRect();

          const x1 = rectA.left + rectA.width / 2 - offset.left;
          const y1 = rectA.top + rectA.height / 2 - offset.top;
          const x2 = rectB.left + rectB.width / 2 - offset.left;
          const y2 = rectB.top + rectB.height / 2 - offset.top;
          const midX = (x1 + x2) / 2;

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('class', 'connector-line');
          path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
          connectorsLayer.appendChild(path);
        });
      }

      function rememberPosition(nodeEl) {
        const slug = nodeEl.dataset.nodeId;
        if (!slug) return;

        const x = Math.round(parseFloat(nodeEl.style.left) || 0);
        const y = Math.round(parseFloat(nodeEl.style.top) || 0);

        pendingPositions.set(slug, { x, y });
      }

      function onPointerDown(event) {
        if (event.button !== 0 || !canStartDrag(event)) return;

        dragging = true;
        pointerId = event.pointerId;
        draggedNode = event.currentTarget;
        hasMoved = false;

        draggedNode.setPointerCapture?.(pointerId);
        draggedNode.classList.add('is-dragging');

        const rect = draggedNode.getBoundingClientRect();
        offsetX = event.clientX - rect.left;
        offsetY = event.clientY - rect.top;
      }

      function onPointerMove(event) {
        if (!dragging || event.pointerId !== pointerId) return;
        event.preventDefault();

        const canvasRect = stage.getBoundingClientRect();
        const maxX = stage.clientWidth - draggedNode.offsetWidth;
        const maxY = stage.clientHeight - draggedNode.offsetHeight;

        const nextX = clamp(event.clientX - canvasRect.left - offsetX, 0, maxX);
        const nextY = clamp(event.clientY - canvasRect.top - offsetY, 0, maxY);

        draggedNode.style.left = `${nextX}px`;
        draggedNode.style.top = `${nextY}px`;
        hasMoved = true;
        updateConnectors();
      }

      function stopDrag(event) {
        if (event.pointerId !== pointerId || !draggedNode) return;

        draggedNode.releasePointerCapture?.(pointerId);
        draggedNode.classList.remove('is-dragging');

        if (hasMoved) {
          rememberPosition(draggedNode);
        }

        dragging = false;
        pointerId = null;
        draggedNode = null;
        hasMoved = false;
        updateConnectors();
      }

      function persistPosition(nodeEl, coords) {
        const url = nodeEl.dataset.positionUrl;
        if (!url) return Promise.resolve();

        return fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify(coords),
        }).then(response => {
          if (!response.ok) {
            throw new Error(`Failed to save ${nodeEl.dataset.nodeId}: ${response.status}`);
          }
          return response.json().catch(() => ({}));
        });
      }

      async function persistPendingPositions() {
        if (!pendingPositions.size) return;

        const tasks = [];
        pendingPositions.forEach((coords, slug) => {
          const node = nodeMap.get(slug);
          if (!node) return;
          tasks.push(persistPosition(node, coords));
        });

        if (!tasks.length) return;

        await Promise.all(tasks);
        pendingPositions.clear();
      }

      nodes.forEach(node => {
        node.addEventListener('pointerdown', onPointerDown);
        node.addEventListener('pointermove', onPointerMove);
        node.addEventListener('pointerup', stopDrag);
        node.addEventListener('pointercancel', stopDrag);
      });

      if (form) {
        let bypassInterceptor = false;

        form.addEventListener('submit', async (event) => {
          if (bypassInterceptor || !pendingPositions.size) {
            return;
          }

          event.preventDefault();
          try {
            await persistPendingPositions();
          } catch (error) {
            console.error('Не удалось сохранить позиции узлов', error);
            return;
          }

          bypassInterceptor = true;
          form.requestSubmit();
          bypassInterceptor = false;
        });
      }

      document.querySelectorAll('.sidebar-toggle').forEach(button => {
        button.addEventListener('click', () => {
          const target = document.querySelector(`.sidebar-submenu[data-menu="${button.dataset.toggle}"]`);
          const icon = button.querySelector('[data-toggle-icon]');
          if (!target) return;
          target.classList.toggle('show');
          icon?.classList.toggle('rotate');
        });
      });

      const tempRange = document.querySelector('[data-role="agent-temp"]');
      const tempValue = document.querySelector('[data-role="agent-temp-value"]');
      tempRange?.addEventListener('pointerdown', event => event.stopPropagation());
      tempRange?.addEventListener('input', () => {
        if (tempValue) tempValue.textContent = Number(tempRange.value).toFixed(1);
      });

      window.addEventListener('resize', updateConnectors);
      updateConnectors();
    })();
</script>
<script>
    (function () {
      const pane = document.getElementById('templates-pane');
      if (!pane) return;
    
      pane.classList.add('templates-pane--editor');
      const bleed = pane.closest('.templates-bleed');
      bleed?.classList.add('templates-bleed--editor');
    
      // когда нажимаешь «Вернуться к блокам» (hx-get), HTMX перерисует #templates-pane,
      // класс исчезнет сам. Если хотите убрать класс вручную при закрытии редактора,
      // можно повесить hx-on="htmx:afterSwap" на кнопку.
    })();
</script>
<script>
    document.querySelectorAll('[data-editor-fallback]').forEach(btn => {
      btn.addEventListener('click', function (event) {
        if (!document.getElementById('templates-pane')) {
          window.location.href = this.dataset.editorFallback;
        }
      });
    });
</script>
<script>
    (function () {
      const form = document.getElementById('editor-model-form');
      if (!form) return;
  
      const pane = document.getElementById('templates-pane');
  
      function currentFilterUrl(fallbackProduct, fallbackSection) {
        const binding = window.__getCurrentBlockBinding?.() || {};
        const product = (binding.productShort || fallbackProduct || '').toUpperCase();
        const section = binding.sectionId || fallbackSection || '';
        const params = new URLSearchParams({ tab: 'templates' });
        if (product) params.set('product', product);
        if (section) params.set('section', section);
        return `/blocks/?${params.toString()}`;
      }
  
      const fallbackProduct = '{{ block.product.short_name|default_if_none:"" }}';
      const fallbackSection = '{{ block.section_id|default_if_none:"" }}';
      const returnUrl = currentFilterUrl(fallbackProduct, fallbackSection);
  
      const nextInput = form.querySelector('input[name="next"]');
      if (nextInput) nextInput.value = returnUrl;
  
      if (pane) {
        form.setAttribute('hx-post', form.getAttribute('action') || '');
        form.setAttribute('hx-target', '#templates-pane');
        form.setAttribute('hx-swap', 'innerHTML');
        form.setAttribute('hx-indicator', '#templates-loading');
        if (window.htmx?.process) {
          window.htmx.process(form);
        }
        form.addEventListener('htmx:afterRequest', (event) => {
          if (event.detail.successful) {
            window.htmx.ajax('GET', returnUrl, '#templates-pane');
          }
        });
      }
    })();
</script>