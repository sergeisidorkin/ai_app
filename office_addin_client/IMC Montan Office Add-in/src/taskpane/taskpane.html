<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="imc-logs-url" content="https://localhost:8001">
    <meta name="imc-logs-token" content="">
    <meta name="imc-test-skip-docx" content="0">
    <meta name="imc-test-ignore-anchor" content="0">
    <title>IMC Montan Add-in</title>
    <!-- Office.js CDN -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" crossorigin="anonymous"></script>
    <!-- Base URL для локалок -->
    <meta name="addin-base-public" content="https://localhost:8001">
    <!-- Fluent UI CSS -->
    <link rel="stylesheet" href="https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/office-ui-fabric-core/11.1.0/css/fabric.min.css" />
    <link href="./taskpane.css" rel="stylesheet" />
    <style>
        .wrap {
            margin-top: 1rem;
            padding: .5rem;
            border: 1px solid #eee;
            border-radius: .5rem
        }
        .row {
            display: flex;
            gap: .5rem;
            align-items: center;
            flex-wrap: wrap
        }
        #log {
            font: 12px/1.35 monospace;
            margin-top: .5rem;
            max-height: 160px;
            overflow: auto;
            background: #f7f7f7;
            padding: .5rem;
            border: 1px solid #eee;
            border-radius: .25rem
        }
    </style>
</head>
<body class="ms-font-m ms-welcome ms-Fabric">
<header class="ms-welcome__header ms-bgColor-neutralLighter">
    <img width="90" height="90" src="../../assets/logo-filled.png" alt="IMC" />
    <h1 class="ms-font-su">IMC Montan</h1>
</header>
<section id="sideload-msg" class="ms-welcome__main">
    <h2 class="ms-font-xl">
        Please <a target="_blank" href="https://learn.microsoft.com/office/dev/add-ins/testing/test-debug-office-add-ins#sideload-an-office-add-in-for-testing">sideload</a> your add-in to see app body.
    </h2>
</section>
<main id="app-body" class="ms-welcome__main" style="display:flex">
    <h2 class="ms-font-xl">Интеграция с Word</h2>
    <div class="wrap">
        <div class="row">
            <input id="email-input" type="email" placeholder="you@example.com" style="flex:1; min-width: 220px;" />
            <button id="connect-btn">Подключить</button>
            <button id="push-test-btn" title="Сервер → Word">Push test</button>
            <button id="run" class="ms-Button ms-Button--hero">Insert Hello</button>
        </div>
        <pre id="log"></pre>
    </div>
    <p><label id="item-subject"></label></p>
</main>
<!-- ========================================================================
     DOCOPS CORE ENGINE
     ======================================================================== -->
<script src="https://localhost:8001/static/core/js/docops-core.js"></script>
<!-- ========================================================================
     OFFICE AWAITING HELPER
     ======================================================================== -->
<script>
    (function() {
        function _resolve() {/* no-op */}
        window.waitOfficeReady = function waitOfficeReady() {
            if (window.__waitOfficeReadyPromise) return window.__waitOfficeReadyPromise;

            window.__waitOfficeReadyPromise = new Promise(function(resolve) {
                function done() {
                    try {
                        _resolve();
                    } catch(e) {}
                    resolve();
                }

                try {
                    if (window.Office && typeof window.Office.onReady === "function") {
                        try {
                            window.Office.onReady().then(done).catch(done);
                            return;
                        } catch(_) {}
                    }
                } catch(_) {}

                var tries = 0, iv = setInterval(function() {
                    tries++;
                    if (window.Office && typeof window.Office.onReady === "function") {
                        clearInterval(iv);
                        try {
                            window.Office.onReady().then(done).catch(done);
                        } catch(_) {
                            done();
                        }
                    } else if (tries > 200) {
                        clearInterval(iv);
                        done();
                    }
                }, 50);
            });

            return window.__waitOfficeReadyPromise;
        };
    }());
</script>
<!-- ========================================================================
     LOGS CONFIG LOADER (загружает токен из Django)
     ======================================================================== -->
<script>
    (function loadLogsConfig(){
        try {
            var baseMeta  = document.querySelector('meta[name="addin-base-public"]');
            var tokenMeta = document.querySelector('meta[name="imc-logs-token"]');
            var urlMeta   = document.querySelector('meta[name="imc-logs-url"]');
            var base = (baseMeta && baseMeta.content) ? baseMeta.content : location.origin;
            var cfgUrl = (base.replace(/\/$/,'') + '/logs/api/config');

            // Важно: вызвать ЗАРАНЕЕ, чтобы meta заполнились до первого log/WS.
            fetch(cfgUrl, { credentials: 'omit' })
                .then(function(r){ return r.ok ? r.json() : Promise.reject(new Error('cfg http '+r.status)); })
                .then(function(cfg){
                    if (cfg && typeof cfg === 'object') {
                        if (cfg.logs_token && tokenMeta) tokenMeta.content = String(cfg.logs_token);
                        if (cfg.logs_url && urlMeta)     urlMeta.content   = String(cfg.logs_url);
                        // Если DocOpsCore кэширует конфиг — дадим сигнал перечитать
                        if (window.DocOpsCore && typeof window.DocOpsCore.refreshLoggingConfig === 'function') {
                            try { window.DocOpsCore.refreshLoggingConfig(); } catch(_){}
                        }
                    }
                })
                .catch(function(_){ /* мягко молчим — останемся без токена */ });
        } catch(_){}
    })();
</script>
<!-- ========================================================================
     WORD.RUN SERIALIZER (optional but recommended)
     ======================================================================== -->
<script>
    (function installWordRunSerializer(){
        try {
            if (!window.Word || !Word.run || Word.run.__serialPatched) return;

            const orig = Word.run.bind(Word);
            let tail = Promise.resolve();

            Word.run = function serial(fn){
                tail = tail.then(() => orig(fn));
                return tail;
            };

            Word.run.__serialPatched = true;
            window.__wordRunTail = () => tail;

            console.log('[word-serializer] installed');
        } catch(_) {}
    })();
</script>
<!-- ========================================================================
     ADDITIONAL HELPERS (pickSafeInsertHost, etc.)
     ======================================================================== -->
<script>
    // Extend DocOpsCore with custom pickSafeInsertHost if needed
    (function() {
        if (typeof DocOpsCore !== 'undefined' && typeof window.pickSafeInsertHost === 'function') {
            DocOpsCore.pickSafeInsertHost = window.pickSafeInsertHost;
        }
    })();
</script>
</body>
</html>